---
title: useApiAuth
description: API 认证 composable，提供登录、登出和 Session 管理，与 nuxt-auth-utils 无缝集成。
---

## Usage

使用自动导入的 `useApiAuth` composable 管理用户认证，包括登录、登出、Session 管理等功能。与 [nuxt-auth-utils](https://github.com/atinux/nuxt-auth-utils) 完全集成。

```vue
<script setup lang="ts">
// 获取认证相关方法和状态
const { login, clear, loggedIn, user } = useApiAuth()

// 基础登录
const handleLogin = async () => {
  await login({
    loginPath: '/auth/login',
    credentials: {
      username: 'admin',
      password: '123456'
    }
  })

  // 登录成功后跳转
  if (loggedIn.value) {
    navigateTo('/dashboard')
  }
}

// 登出
const handleLogout = async () => {
  await clear()
  navigateTo('/login')
}

// 响应式状态
watchEffect(() => {
  if (loggedIn.value) {
    console.log('当前用户:', user.value)
  }
})
</script>
```

- `useApiAuth` 基于 `nuxt-auth-utils` 提供的 Session 管理功能。
- 支持自动获取用户信息、自定义 token 提取和 session 构建。
- 登录后 token 会自动添加到后续 API 请求的请求头。

::note
`useApiAuth` 依赖 `nuxt-auth-utils` 模块。确保已安装并正确配置该模块。
::

::tip{icon="i-lucide-settings" to="/docs/getting-started/configuration#auth"}
了解认证相关的全局配置选项
::


## 登录流程

`login()` 方法执行以下步骤:

1. 调用登录接口，传递凭证
2. 从响应中提取 token(通过 `tokenExtractor`)
3. 如果提供 `userInfoPath`，使用 token 调用用户信息接口
4. 构建 session 数据(通过 `sessionBuilder`)
5. 设置 session 到服务端
6. 刷新客户端 session 状态

```ts
// 完整流程示例
await login({
  // 1. 登录接口
  loginPath: '/auth/login',
  credentials: { username: 'admin', password: '123456' },

  // 2. 用户信息接口(可选)
  userInfoPath: '/auth/me',

  // 3. 自定义 token 提取
  tokenExtractor: (res) => res.data?.accessToken,

  // 4. 自定义 session 构建
  sessionBuilder: (user, token) => ({
    user: { id: user.id, name: user.name },
    secure: { token, permissions: user.permissions }
  })
})
```

## Token 提取

默认 `tokenExtractor` 会依次尝试以下路径:

1. `data.token`
2. `data.accessToken`
3. `token`

::tip
如果 API 响应格式不同，可以自定义提取逻辑:
::

```ts
// 自定义 token 路径
await login({
  loginPath: '/auth/login',
  credentials: { username: 'admin', password: '123456' },
  tokenExtractor: (res) => res.data?.jwt  // 从 data.jwt 提取
})

// 复杂嵌套结构
await login({
  loginPath: '/auth/login',
  credentials: { username: 'admin', password: '123456' },
  tokenExtractor: (res) => res.data?.session?.accessToken
})
```

## Session 构建

默认 `sessionBuilder` 构建以下 session 结构:

```ts
{
  user: User,           // 用户信息
  token: string,        // 访问令牌
  loggedInAt: string    // 登录时间(ISO 格式)
}
```

::tip
可以自定义 session 结构，例如分离敏感数据:
::

```ts
await login({
  loginPath: '/auth/login',
  credentials: { username: 'admin', password: '123456' },
  sessionBuilder: (user, token) => ({
    user: {
      id: user.id,
      name: user.name,
      avatar: user.avatar
    },
    secure: {
      token,
      refreshToken: user.refreshToken,
      permissions: user.permissions
    }
  })
})
```

::note
`nuxt-auth-utils` 会自动加密 `secure` 字段，保护敏感数据。
::

## 用户信息获取

有两种方式获取用户信息:

### 方式 1: 从登录响应获取

```ts
// 登录响应包含用户信息
await login({
  loginPath: '/auth/login',
  credentials: { username: 'admin', password: '123456' }
})

// 用户信息从登录响应的 data 字段提取
```

登录响应格式示例:

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "id": 1,
    "name": "Admin",
    "email": "admin@example.com"
  }
}
```

### 方式 2: 调用独立的用户信息接口

```ts
// 使用 userInfoPath 自动调用用户信息接口
await login({
  loginPath: '/auth/login',
  credentials: { username: 'admin', password: '123456' },
  userInfoPath: '/auth/me'  // 使用 token 调用此接口
})
```

此方式会自动:
1. 从登录响应提取 token
2. 使用 token 调用 `/auth/me`
3. 将用户信息接口的响应作为用户数据

## API

### useApiAuth()

`useApiAuth(): UseApiAuthReturn`{lang="ts-type"}

创建认证管理器。

#### Returns

返回包含以下方法和属性的认证管理器对象:

::field-group

  ::field{name="login()" type="<LoginRData = unknown>(options: LoginOptions<LoginRData>) => Promise<LoginResult>"}
  执行登录流程。

    ::collapsible
      **Parameters**

      ::field-group
        ::field{name="loginPath" type="string" required}
        登录接口路径。
        ::

        ::field{name="credentials" type="Record<string, unknown>" required}
        登录凭证(如用户名、密码)。
        ::

        ::field{name="userInfoPath" type="string"}
        用户信息接口路径。如果提供，登录后会使用 token 调用此接口获取用户信息。
        ::

        ::field{name="tokenExtractor" type="(response: ApiResponse<LoginRData>) => string | null | undefined"}
        自定义 token 提取函数。默认从 `data.token`、`data.accessToken` 或 `token` 字段提取。
        ::

        ::field{name="sessionBuilder" type="(user: User, token: string) => UserSession"}
        自定义 session 构建函数。默认返回 `{ user, token, loggedInAt }`。
        ::

        ::field{name="endpoint" type="string"}
        使用指定的端点配置。
        ::
      ::

      **Returns**

      返回 `Promise<LoginResult>`，包含:
      - `user: User` - 用户信息
      - `token: string` - 访问令牌
    ::
  ::

  ::field{name="loggedIn" type="Ref<boolean>"}
  是否已登录(响应式)。
  ::

  ::field{name="user" type="Ref<User | null>"}
  当前用户信息(响应式)。
  ::

  ::field{name="session" type="Ref<UserSession | null>"}
  当前 session 数据(响应式)。
  ::

  ::field{name="fetch()" type="() => Promise<void>"}
  刷新 session 状态。
  ::

  ::field{name="clear()" type="() => Promise<void>"}
  清除 session(登出)。
  ::
::

## Changelog

:commit-changelog{prefix="/composables" suffix="ts"}
