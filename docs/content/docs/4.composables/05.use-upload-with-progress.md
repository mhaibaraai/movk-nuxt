---
title: useUploadWithProgress
description: 带进度监控的文件上传 composable，支持实时进度和取消上传。
---

## Usage

使用自动导入的 `useUploadWithProgress` composable 进行文件上传，基于原生 `XMLHttpRequest` 实现，支持实时进度监控和取消上传。

```vue
<script setup lang="ts">
// 获取上传相关方法和状态
const { progress, uploading, upload, abort } = useUploadWithProgress()

// 上传文件
const handleUpload = async (files: File[]) => {
  const result = await upload('/api/upload', files, {
    onSuccess: (response) => {
      console.log('上传成功:', response)
    }
  })

  if (result.data) {
    console.log('服务器返回:', result.data)
  }
}

// 取消上传
const handleCancel = () => {
  abort()
}
</script>

<template>
  <div>
    <UFileUpload @change="handleUpload" :loading="uploading" />

    <div v-if="uploading" class="mt-4">
      <UProgress :model-value="progress" :max="100"/>
      <p>上传中: {{ progress }}%</p>
      <UButton color="red" @click="handleCancel">取消</UButton>
    </div>
  </div>
</template>
```

- `useUploadWithProgress` 基于原生 `XMLHttpRequest` 实现，支持上传进度监听。
- 支持自动认证(从 session 获取 token)。
- 自动检查业务状态码。
- 内置 Toast 提示。

::note
适用于需要展示上传进度的场景，如图片上传、文件管理等。对于无需进度的小文件，可以直接使用 `$api.$fetch`。
::

::tip{icon="i-lucide-settings" to="/docs/getting-started/configuration#api-系统配置"}
了解 API 系统的全局配置选项
::

## API

### useUploadWithProgress()

`useUploadWithProgress<T = unknown>(): { progress, uploading, data, error, upload, abort }`{lang="ts-type"}

创建上传管理器。

#### Type Parameters

::field-group
  ::field{name="T" type="type"}
  服务器响应 `data` 字段的类型。
  ::
::

#### Returns

返回包含以下方法和属性的上传管理器对象:

::field-group
  ::field{name="progress" type="Ref<number>"}
  上传进度,范围 0-100。
  ::

  ::field{name="uploading" type="Ref<boolean>"}
  是否正在上传中。
  ::

  ::field{name="data" type="Ref<ApiResponse<T> | null>"}
  服务器响应数据。
  ::

  ::field{name="error" type="Ref<Error | null>"}
  错误信息(如果上传失败)。
  ::

  ::field{name="upload()" type="(url: string, files: File | File[], options?: UploadWithProgressOptions) => Promise<{ data: ApiResponse<T> | null, error: Error | null }>"}
  执行上传。

  ::collapsible
    **Parameters**

    ::field-group
      ::field{name="url" type="string" required}
      上传文件的 URL。
      ::

      ::field{name="files" type="File | File[]" required}
      要上传的文件或文件数组。
      ::

      ::field{name="options" type="UploadWithProgressOptions"}
      上传配置选项。

      ::collapsible
        ::field-group
          ::field{name="fieldName" type="string"}
          文件字段名。默认 `'file'`。
          ::

          ::field{name="fields" type="Record<string, string | Blob>"}
          额外的表单字段。
          ::

          ::field{name="headers" type="Record<string, string>"}
          额外的请求头。
          ::

          ::field{name="toast" type="RequestToastOptions | false"}
          Toast 提示配置。设为 `false` 禁用 Toast。
          ::

          ::field{name="endpoint" type="string"}
          使用指定的端点配置。
          ::

          ::field{name="onSuccess" type="(response: ApiResponse) => void"}
          上传成功回调，接收服务器响应。
          ::

          ::field{name="onError" type="(error: Error) => void"}
          上传失败回调，接收错误对象。
          ::
        ::
      ::
      ::
    ::

    **Returns**

    返回 `Promise<{ data: ApiResponse<T> | null, error: Error | null }>`:
    - `data` - 服务器响应数据(成功时)
    - `error` - 错误信息(失败时)
  ::
  ::

  ::field{name="abort()" type="() => void"}
  中止当前上传，重置进度和状态。
  ::
::

## 单文件 vs 多文件上传

`upload()` 方法支持单个文件和多个文件:

```ts
// 单文件上传
await upload('/api/upload', file, {
  fieldName: 'file'
})
// FormData: file=<File>

// 多文件上传
await upload('/api/upload', [file1, file2, file3], {
  fieldName: 'files'
})
// FormData: files=<File>, files=<File>, files=<File>
```

## 额外表单字段

可以附加额外的表单字段:

```ts
await upload('/api/upload', file, {
  fieldName: 'avatar',
  fields: {
    userId: '123',
    category: 'profile',
    description: '用户头像'
  }
})

// FormData:
// avatar=<File>
// userId=123
// category=profile
// description=用户头像
```

## 业务状态码检查

`useUploadWithProgress` 会自动检查业务状态码:

```ts
// 成功响应
{
  code: 200,
  message: '上传成功',
  data: { url: 'https://cdn.example.com/file.jpg' }
}
// 触发 onSuccess 回调,显示成功 Toast

// 失败响应
{
  code: 400,
  message: '文件类型不支持'
}
// 触发 onError 回调,显示错误 Toast
```

业务状态码规则由模块配置的 `response` 选项控制。

## 取消上传

使用 `abort()` 方法取消正在进行的上传:

```ts
const { uploading, upload, abort } = useUploadWithProgress()

// 开始上传
upload('/api/upload', largeFile)

// 用户点击取消
const handleCancel = () => {
  if (uploading.value) {
    abort()  // 中止上传
  }
}
```

取消上传后:
- `uploading` 变为 `false`
- `progress` 重置为 `0`
- `error` 设为 `new Error('上传已取消')`
- 不会显示 Toast 提示

## Example

以下是一个完整的使用示例:

```vue
<script setup lang="ts">
interface UploadResult {
  url: string
  filename: string
  size: number
}

const { progress, uploading, data, error, upload, abort } = useUploadWithProgress<UploadResult>()

const uploadedFiles = ref<UploadResult[]>([])
const selectedFiles = ref<File[]>([])

// 1. 基础单文件上传
const handleSingleUpload = async (file: File) => {
  const result = await upload('/api/upload', file, {
    fieldName: 'file',
    onSuccess: (response) => {
      if (response.data) {
        uploadedFiles.value.push(response.data)
      }
    }
  })

  return result
}

// 2. 多文件上传
const handleMultipleUpload = async (files: File[]) => {
  const result = await upload('/api/upload/batch', files, {
    fieldName: 'files',
    toast: {
      success: `成功上传 ${files.length} 个文件`,
      error: '上传失败,请重试'
    }
  })

  return result
}

// 3. 带额外字段的上传
const handleUploadWithMetadata = async (file: File) => {
  await upload('/api/upload', file, {
    fieldName: 'image',
    fields: {
      userId: '123',
      category: 'avatar',
      isPublic: 'true'
    }
  })
}

// 4. 自定义请求头
const handleUploadWithHeaders = async (file: File) => {
  await upload('/api/upload', file, {
    headers: {
      'X-Upload-Source': 'web',
      'X-File-Type': file.type
    }
  })
}

// 5. 图片预览 + 上传
const imagePreview = ref<string | null>(null)

const handleImageUpload = async (file: File) => {
  // 生成预览
  imagePreview.value = URL.createObjectURL(file)

  // 上传
  const result = await upload('/api/upload/image', file, {
    fieldName: 'image',
    onSuccess: (response) => {
      console.log('图片 URL:', response.data?.url)
    }
  })

  if (!result.error) {
    // 上传成功后清除本地预览
    URL.revokeObjectURL(imagePreview.value!)
    imagePreview.value = response.data?.url || null
  }
}

// 6. 批量上传(逐个)
const batchUpload = async (files: File[]) => {
  const results: UploadResult[] = []

  for (const file of files) {
    const result = await upload('/api/upload', file, {
      toast: { success: false }  // 禁用单个文件的成功提示
    })

    if (result.data) {
      results.push(result.data.data!)
    } else {
      console.error(`上传失败: ${file.name}`)
      break
    }
  }

  // 批量上传完成
  if (results.length === files.length) {
    uploadedFiles.value.push(...results)
    console.log('所有文件上传完成')
  }
}

// 7. 文件类型验证
const validateAndUpload = async (file: File) => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif']
  const maxSize = 5 * 1024 * 1024  // 5MB

  if (!allowedTypes.includes(file.type)) {
    error.value = new Error('仅支持 JPEG、PNG、GIF 格式')
    return
  }

  if (file.size > maxSize) {
    error.value = new Error('文件大小不能超过 5MB')
    return
  }

  await upload('/api/upload', file)
}

// 8. 使用不同端点
const handleAdminUpload = async (file: File) => {
  await upload('/admin/upload', file, {
    endpoint: 'admin'
  })
}

// 9. 取消上传
const handleCancel = () => {
  abort()
}

// 10. 监听上传结果
watch(data, (newData) => {
  if (newData?.data) {
    console.log('上传成功:', newData.data)
  }
})

watch(error, (newError) => {
  if (newError) {
    console.error('上传错误:', newError.message)
  }
})
</script>
```

## Caveats

### FormData 格式

`useUploadWithProgress` 使用 `multipart/form-data` 格式上传:

```ts
// 客户端
await upload('/api/upload', file, {
  fieldName: 'avatar',
  fields: { userId: '123' }
})

// 服务端需要支持 multipart/form-data
// 使用 Multer、Busboy 等中间件解析
router.post('/upload', upload.single('avatar'), (req, res) => {
  const file = req.file
  const userId = req.body.userId
})
```

### 认证集成

`useUploadWithProgress` 会自动从 session 获取 token 并添加到请求头:

```ts
// 自动添加 Authorization 头
await upload('/api/upload', file)
// 请求头: Authorization: Bearer <token>
```

如需额外的请求头:

```ts
await upload('/api/upload', file, {
  headers: {
    'X-Custom-Header': 'value'
  }
})
```

## Changelog

:commit-changelog{prefix="/composables" suffix="ts"}
